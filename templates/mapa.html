<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa Osinergmin</title>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3IksI"></script>

<style>
body { font-family: Arial; margin:0; }
#map { height: 90vh; width: 100%; }
#panel {
  padding:10px;
  background:#f2f2f2;
}
select,input {
  margin:3px;
  padding:5px;
}
#estadisticas {
  padding:8px;
  font-size:14px;
}
</style>
</head>

<body>

<div id="panel">
  ðŸ”Ž Buscar: <input type="text" id="busqueda" placeholder="CÃ³digo o RazÃ³n Social">

  Actividad:
  <select id="filtroActividad"></select>

  Estado:
  <select id="filtroEstado"></select>

  Provincia:
  <select id="filtroProvincia"></select>

  Distrito:
  <select id="filtroDistrito"></select>

  <span id="contador"></span>
</div>

<div id="map"></div>

<div id="estadisticas"></div>

<script>
let map;
let markers = [];
let datos = [];

const colores = {};
const paleta = ["red","blue","green","orange","purple","pink","yellow","brown","gray","black"];

function asignarColor(act){
  if(!colores[act]){
    colores[act] = paleta[Object.keys(colores).length % paleta.length];
  }
  return colores[act];
}

function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:-12.1,lng:-77.05},
    zoom:10
  });

  fetch("/datos")
    .then(r=>r.json())
    .then(r=>{
      datos = r;
      cargarFiltros();
      mostrarMarcadores();
      generarLeyenda();
      generarEstadisticas();
    });
}

function cargarFiltros(){
  llenarSelect("filtroActividad", [...new Set(datos.map(d=>d.actividad))]);
  llenarSelect("filtroEstado", [...new Set(datos.map(d=>d.estado))]);
  llenarSelect("filtroProvincia", [...new Set(datos.map(d=>d.provincia))]);
  llenarSelect("filtroDistrito", [...new Set(datos.map(d=>d.distrito))]);

  document.querySelectorAll("select,input").forEach(e=>{
    e.addEventListener("change", aplicarFiltros);
    e.addEventListener("keyup", aplicarFiltros);
  });
}

function llenarSelect(id, lista){
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">Todos</option>';
  lista.sort().forEach(v=>{
    if(v) sel.innerHTML += `<option>${v}</option>`;
  });
}

function mostrarMarcadores(filtrados=datos){
  markers.forEach(m=>m.setMap(null));
  markers=[];

  filtrados.forEach(d=>{
    const marker = new google.maps.Marker({
      position:{lat:parseFloat(d.lat), lng:parseFloat(d.lng)},
      map:map,
      icon:{
        path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
        scale:5,
        fillColor:asignarColor(d.actividad),
        fillOpacity:1,
        strokeWeight:1
      }
    });

    const info = `
      <b>${d.razon}</b><br>
      CÃ³digo: ${d.codigo}<br>
      Registro: ${d.registro}<br>
      Actividad: ${d.actividad}<br>
      Capacidad: ${d.capacidad}<br>
      Ãšltima FiscalizaciÃ³n: ${d.fiscalizacion}<br>
      Estado: ${d.estado}
    `;

    const infowindow = new google.maps.InfoWindow({content:info});
    marker.addListener("click",()=>infowindow.open(map,marker));
    markers.push(marker);
  });

  document.getElementById("contador").innerHTML =
   "Total: " + filtrados.length;
}

function aplicarFiltros(){
  const act = document.getElementById("filtroActividad").value;
  const est = document.getElementById("filtroEstado").value;
  const prov = document.getElementById("filtroProvincia").value;
  const dist = document.getElementById("filtroDistrito").value;
  const bus = document.getElementById("busqueda").value.toLowerCase();

  const filtrados = datos.filter(d=>{
    return (!act || d.actividad==act) &&
           (!est || d.estado==est) &&
           (!prov || d.provincia==prov) &&
           (!dist || d.distrito==dist) &&
           (!bus || d.codigo.toLowerCase().includes(bus) || d.razon.toLowerCase().includes(bus));
  });

  mostrarMarcadores(filtrados);
  generarEstadisticas(filtrados);
}

function generarLeyenda(){
  let html="<b>Leyenda por actividad</b><br>";
  for(let act in colores){
    html += `<span style="color:${colores[act]}">â¬¤</span> ${act}<br>`;
  }
  document.getElementById("estadisticas").innerHTML = html;
}

function generarEstadisticas(filtrados=datos){
  const conteoProv = {};
  filtrados.forEach(d=>{
    conteoProv[d.provincia] = (conteoProv[d.provincia]||0)+1;
  });

  let html = document.getElementById("estadisticas").innerHTML;
  html += "<hr><b>EstadÃ­sticas por Provincia</b><br>";
  for(let p in conteoProv){
    html += `${p}: ${conteoProv[p]}<br>`;
  }
  document.getElementById("estadisticas").innerHTML = html;
}

window.onload = initMap;
</script>

</body>
</html>
