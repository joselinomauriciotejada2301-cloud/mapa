<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
html, body { height:100%; margin:0; font-family:Arial; }
#map { height:100%; }

/* ===== PANEL IZQUIERDO ===== */
.panel{
 position:absolute; top:10px; left:10px; z-index:5;
 background:white; padding:12px; border-radius:8px;
 box-shadow:2px 2px 6px #999; width:330px; font-size:13px;
}

/* ===== PANEL FILTROS HORIZONTAL ARRIBA ===== */
.panelFiltros{
 position:absolute;
 top:10px;
 left:360px;
 right:10px;
 z-index:6;
 background:white;
 padding:10px;
 border-radius:8px;
 box-shadow:2px 2px 6px #999;
 display:flex;
 gap:8px;
 align-items:center;
 flex-wrap:wrap;
 font-size:13px;
}

/* Selects horizontales */
.panelFiltros select{
 height:28px;
 min-width:180px;
 flex:1;
}

/* Bot√≥n limpiar filtros en horizontal */
.panelFiltros button{
 height:30px;
 padding:0 12px;
 border-radius:6px;
 cursor:pointer;
}

/* ===== INPUTS Y BOTONES DEL PANEL IZQUIERDO ===== */
.panel select, .panel input, .panel button{
 width:100%; margin-bottom:6px;
}

.panel select{ height:28px; }

.stats{
 margin-top:8px; font-size:12px;
 max-height:250px; overflow:auto; display:none;
}

.legend{ display:none; }

.color-box{
 display:inline-block;
 width:10px;
 height:10px;
 margin-right:6px;
 border-radius:2px;
}

/* ===== SLIDER DISTANCIA ===== */
.distancia-box{
 margin: 6px 0 10px 0;
 padding: 8px;
 border: 1px solid #ddd;
 border-radius: 6px;
 background: #fafafa;
}

.distancia-box label{
 font-size: 12px;
 font-weight: bold;
 display:block;
 margin-bottom: 6px;
}

.distancia-box input[type="range"]{
 width:100%;
}

.distancia-valor{
 font-size: 12px;
 margin-top: 4px;
 text-align:right;
 font-weight:bold;
}

/* ===== MEDICION ===== */
.medicion-box{
 margin-top: 6px;
 padding: 8px;
 border: 1px solid #ddd;
 border-radius: 6px;
 background: #f7fbff;
}

.medicion-box b{
 display:block;
 margin-bottom:6px;
}

.medicion-dist{
 font-size: 12px;
 margin-top: 6px;
 font-weight: bold;
 text-align: right;
}

.btn-on{
 background:#1a73e8;
 color:white;
 border:none;
 padding:6px;
 border-radius:6px;
 cursor:pointer;
}

/* ===== RESPONSIVE ===== */
@media(max-width:900px){
 .panelFiltros{
  left:10px;
  top:320px;
 }
 .panel{
  width:320px;
 }
}
</style>
</head>

<body>

<!-- ===== FILTROS ARRIBA HORIZONTAL ===== -->
<div class="panelFiltros">
 <select id="f_estado" multiple size="1"></select>
 <select id="f_actividad" multiple size="1"></select>
 <select id="f_provincia" multiple size="1"></select>
 <select id="f_distrito" multiple size="1"></select>
 <select id="f_anio" multiple size="1"></select>
 <button onclick="resetFiltros()">Limpiar filtros</button>
</div>

<!-- ===== PANEL IZQUIERDO VERTICAL ===== -->
<div class="panel">
<b>üîé Buscador</b>
<input type="text" id="buscador" placeholder="C√≥digo o Raz√≥n Social">
<button onclick="buscar()">Buscar</button>

<!-- ===== REGULADOR DE DISTANCIA ===== -->
<div class="distancia-box">
 <label>üìè Radio de b√∫squeda (metros)</label>
 <input type="range" id="sliderDistancia" min="100" max="1000" step="50" value="500" oninput="actualizarTextoDistancia()">
 <div class="distancia-valor" id="txtDistancia">500 m</div>
</div>

<hr>
<button onclick="toggleHeatmap()">üî• Activar / Desactivar Mapa de Calor</button>

<hr>

<!-- ===== MEDIR DISTANCIA ===== -->
<div class="medicion-box">
 <b>üìè Medir distancia</b>
 <button id="btnMedir" onclick="toggleMedicion()">Activar medici√≥n</button>
 <button onclick="limpiarMedicion()">üßπ Limpiar medici√≥n</button>
 <div class="medicion-dist" id="txtMedicion">0 m</div>
</div>

<hr>
<div id="contador"></div>

<div class="stats" id="panelStats">
 <div id="stats_actividad"></div>
 <div id="stats_geo"></div>
 <div id="stats_total"></div>
</div>

</div>

<div id="map"></div>

<script>
let map, datos=[], marcadores=[], heatmap;
let heatmapActivo=false;
let modoBusqueda=false;

/* ========= COLORES POR ACTIVIDAD ========= */
const paletaColores=[
 "#e74c3c","#3498db","#2ecc71","#f1c40f","#9b59b6",
 "#1abc9c","#e67e22","#34495e","#d35400","#16a085"
];
const colorActividadMap={};

function colorPorActividad(act){
 if(!colorActividadMap[act]){
  const i=Object.keys(colorActividadMap).length % paletaColores.length;
  colorActividadMap[act]=paletaColores[i];
 }
 return colorActividadMap[act];
}

/* ===== PIN ROJO PARA COINCIDENCIAS ===== */
function iconoPinRojo(){
 return {
  path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",
  fillColor: "#d93025",
  fillOpacity: 1,
  strokeColor: "#ffffff",
  strokeWeight: 2,
  scale: 1.6,
  anchor: new google.maps.Point(12, 22)
 };
}

/* ===== ICONO NORMAL POR ACTIVIDAD ===== */
function iconoActividad(actividad){
 return {
  path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
  scale: 5,
  fillColor: colorPorActividad(actividad),
  fillOpacity: 1,
  strokeWeight: 1
 };
}

/* ===== SLIDER ===== */
function actualizarTextoDistancia(){
 let v = document.getElementById("sliderDistancia").value;
 document.getElementById("txtDistancia").innerText = v + " m";
}

/* ==========================================================
   üìè MEDICION DE DISTANCIA (TIPO GOOGLE MAPS)
   ========================================================== */
let medicionActiva=false;
let puntosMedicion=[];
let polylineMedicion=null;
let marcadoresMedicion=[];
let listenerClickMedicion=null;
let listenerDblClickMedicion=null;

function toggleMedicion(){
 medicionActiva=!medicionActiva;

 let btn=document.getElementById("btnMedir");
 if(medicionActiva){
  btn.innerText="Desactivar medici√≥n";
  btn.classList.add("btn-on");
  activarMedicion();
 }else{
  btn.innerText="Activar medici√≥n";
  btn.classList.remove("btn-on");
  desactivarMedicion();
 }
}

function activarMedicion(){
 listenerClickMedicion = map.addListener("click", (e)=>{
  agregarPuntoMedicion(e.latLng);
 });

 listenerDblClickMedicion = map.addListener("dblclick", (e)=>{
  e.stop();
  finalizarMedicion();
 });
}

function desactivarMedicion(){
 if(listenerClickMedicion) google.maps.event.removeListener(listenerClickMedicion);
 if(listenerDblClickMedicion) google.maps.event.removeListener(listenerDblClickMedicion);
 listenerClickMedicion=null;
 listenerDblClickMedicion=null;
}

function agregarPuntoMedicion(latLng){
 puntosMedicion.push(latLng);

 let m=new google.maps.Marker({
  position: latLng,
  map: map,
  icon:{
   path: google.maps.SymbolPath.CIRCLE,
   scale: 5,
   fillColor: "#1a73e8",
   fillOpacity: 1,
   strokeColor: "#ffffff",
   strokeWeight: 2
  }
 });
 marcadoresMedicion.push(m);

 if(!polylineMedicion){
  polylineMedicion=new google.maps.Polyline({
   map: map,
   path: puntosMedicion,
   strokeColor: "#1a73e8",
   strokeOpacity: 1,
   strokeWeight: 3
  });
 }else{
  polylineMedicion.setPath(puntosMedicion);
 }

 actualizarDistanciaMedicion();
}

function actualizarDistanciaMedicion(){
 if(puntosMedicion.length<2){
  document.getElementById("txtMedicion").innerText="0 m";
  return;
 }

 let total=0;
 for(let i=1;i<puntosMedicion.length;i++){
  total += google.maps.geometry.spherical.computeDistanceBetween(
   puntosMedicion[i-1],
   puntosMedicion[i]
  );
 }

 if(total<1000){
  document.getElementById("txtMedicion").innerText = total.toFixed(0) + " m";
 }else{
  document.getElementById("txtMedicion").innerText = (total/1000).toFixed(2) + " km";
 }
}

function finalizarMedicion(){}

function limpiarMedicion(){
 puntosMedicion=[];
 marcadoresMedicion.forEach(m=>m.setMap(null));
 marcadoresMedicion=[];
 if(polylineMedicion) polylineMedicion.setMap(null);
 polylineMedicion=null;
 document.getElementById("txtMedicion").innerText="0 m";
}

/* ===== MAPA ===== */
function initMap(){
 map=new google.maps.Map(document.getElementById("map"),{
  center:{lat:-12.05,lng:-77.05}, zoom:11
 });

 fetch("/datos").then(r=>r.json()).then(d=>{
  datos=d.map(x=>{
   if(x.fiscalizacion){
    const match = String(x.fiscalizacion).match(/\b(19|20)\d{2}\b/);
    x._anioFiscalizacion = match ? match[0] : null;
   }
   return x;
  });

  cargarFiltros();
  dibujarMarcadores(datos);
  construirHeatmap(datos);
  actualizarContador(datos);
  ocultarMarcadores();
  actualizarTextoDistancia();
 });
}

/* ===== HEATMAP ===== */
function construirHeatmap(lista){
 let puntos=lista.map(d=>({
  location:new google.maps.LatLng(d.lat,d.lng),
  weight:Math.sqrt(d.capacidad||1)
 }));
 if(heatmap) heatmap.setMap(null);
 heatmap=new google.maps.visualization.HeatmapLayer({
  data:puntos, radius:40
 });
 if(heatmapActivo) heatmap.setMap(map);
}

function toggleHeatmap(){
 heatmapActivo=!heatmapActivo;
 heatmap.setMap(heatmapActivo?map:null);
}

/* ===== MARCADORES ===== */
function dibujarMarcadores(lista){
 marcadores.forEach(m=>m.setMap(null));
 marcadores=[];

 lista.forEach(d=>{
  let icono = modoBusqueda ? iconoPinRojo() : iconoActividad(d.actividad);

  let marker=new google.maps.Marker({
   position:{lat:d.lat,lng:d.lng},
   map:map,
   icon:icono
  });

  let info=new google.maps.InfoWindow({
   content:`
   <b>${d.razon}</b><br>
   C√≥digo: ${d.codigo}<br>
   Registro: ${d.registro}<br>
   Distrito: ${d.distrito}<br>
   Estado: ${d.estado}<br>
   Capacidad: ${d.capacidad}<br>
   √öltima fiscalizaci√≥n: ${d.fiscalizacion}`
  });

  marker.addListener("click",()=>info.open(map,marker));
  marcadores.push(marker);
 });
}

function ocultarMarcadores(){ marcadores.forEach(m=>m.setMap(null)); }
function mostrarMarcadores(){ marcadores.forEach(m=>m.setMap(map)); }

/* ===== FILTROS ===== */
function cargarFiltros(){
 ["estado","actividad","provincia","distrito"].forEach(c=>{
  let s=document.getElementById("f_"+c);
  [...new Set(datos.map(d=>d[c]))].sort().forEach(v=>{
   if(v){
    let o=document.createElement("option");
    o.value=v;o.text=v;s.add(o);
   }
  });
  s.onchange=aplicarFiltros;
 });

 let s=document.getElementById("f_anio");
 [...new Set(datos.map(d=>d._anioFiscalizacion))]
  .filter(Boolean)
  .sort((a,b)=>b-a)
  .forEach(v=>{
   let o=document.createElement("option");
   o.value=v;o.text=v;s.add(o);
  });
 s.onchange=aplicarFiltros;
}

function valores(id){
 return [...document.getElementById(id).selectedOptions].map(o=>o.value);
}

/* ===== APLICAR FILTROS ===== */
function aplicarFiltros(){
 modoBusqueda=false;
 let f=datos.filter(d=>
  (!valores("f_estado").length||valores("f_estado").includes(d.estado)) &&
  (!valores("f_actividad").length||valores("f_actividad").includes(d.actividad)) &&
  (!valores("f_provincia").length||valores("f_provincia").includes(d.provincia)) &&
  (!valores("f_distrito").length||valores("f_distrito").includes(d.distrito)) &&
  (!valores("f_anio").length||valores("f_anio").includes(d._anioFiscalizacion))
 );

 dibujarMarcadores(f);
 construirHeatmap(f);
 actualizarContador(f);
 actualizarEstadisticas(f);

 f.length?mostrarMarcadores():ocultarMarcadores();
}

/* ===== ESTADISTICAS ===== */
function actualizarEstadisticas(lista){
 let panel=document.getElementById("panelStats");
 if(lista.length===datos.length){ panel.style.display="none"; return; }
 panel.style.display="block";

 let porAct={};
 lista.forEach(d=>porAct[d.actividad]=(porAct[d.actividad]||0)+1);

 let actividadesOrdenadas = Object.entries(porAct)
  .sort((a,b)=>b[1]-a[1]);

 let html="<b>üìå Por Actividad</b><br>";
 actividadesOrdenadas.forEach(([act,cant])=>{
  html+=`
   <div>
    <span class="color-box" style="background:${colorPorActividad(act)}"></span>
    ${act}: ${cant}
   </div>`;
 });
 document.getElementById("stats_actividad").innerHTML=html;

 let porDist={};
 lista.forEach(d=>porDist[d.distrito]=(porDist[d.distrito]||0)+1);

 let distritosOrdenados = Object.entries(porDist)
  .sort((a,b)=>b[1]-a[1]);

 let hd="<br><b>üèòÔ∏è Por Distrito</b><br>";
 distritosOrdenados.forEach(([dist,cant])=>{
  hd+=`${dist}: ${cant}<br>`;
 });
 document.getElementById("stats_geo").innerHTML=hd;

 document.getElementById("stats_total").innerHTML=
 `<br><b>Total general: ${lista.length}</b>`;
}

/* ===== CONTADOR ===== */
function actualizarContador(lista){
 document.getElementById("contador").innerHTML=
 "Total registros: <b>"+lista.length+"</b>";
}

/* ===== BUSCADOR (COINCIDENCIAS + RADIO AJUSTABLE) ===== */
function buscar(){
 let t=document.getElementById("buscador").value.toLowerCase().trim();
 if(!t){ resetFiltros(); return; }

 let coincidencias=datos.filter(d=>
  String(d.codigo).toLowerCase().includes(t) ||
  String(d.razon).toLowerCase().includes(t)
 );

 if(!coincidencias.length){
  alert("No se encontraron coincidencias");
  return;
 }

 const radioMetros = parseInt(document.getElementById("sliderDistancia").value);

 function clave(d){
  return String(d.codigo || "") + "|" + String(d.registro || "") + "|" + String(d.lat) + "|" + String(d.lng);
 }

 let setIncluidos = new Map();
 coincidencias.forEach(d=>setIncluidos.set(clave(d), d));

 datos.forEach(d=>{
  if(d.lat == null || d.lng == null) return;

  for(let c of coincidencias){
   if(c.lat == null || c.lng == null) continue;

   let dist = google.maps.geometry.spherical.computeDistanceBetween(
    new google.maps.LatLng(d.lat, d.lng),
    new google.maps.LatLng(c.lat, c.lng)
   );

   if(dist <= radioMetros){
    setIncluidos.set(clave(d), d);
    break;
   }
  }
 });

 let r = Array.from(setIncluidos.values());

 modoBusqueda=false;
 dibujarMarcadores(r);

 let clavesCoin = new Set(coincidencias.map(d=>clave(d)));

 marcadores.forEach((marker, i)=>{
  let d = r[i];
  if(clavesCoin.has(clave(d))){
   marker.setIcon(iconoPinRojo());
  }
 });

 mostrarMarcadores();
 construirHeatmap(r);
 actualizarContador(r);
 actualizarEstadisticas(r);

 map.setCenter({lat:coincidencias[0].lat,lng:coincidencias[0].lng});
 map.setZoom(r.length==1?15:12);
}

/* ===== RESET ===== */
function resetFiltros(){
 modoBusqueda=false;
 document.querySelectorAll("select").forEach(s=>s.selectedIndex=-1);
 dibujarMarcadores(datos);
 construirHeatmap(datos);
 actualizarContador(datos);
 document.getElementById("panelStats").style.display="none";
 ocultarMarcadores();
}
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization,geometry&callback=initMap">
</script>

</body>
</html>
