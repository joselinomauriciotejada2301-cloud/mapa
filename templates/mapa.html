<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
body{margin:0;font-family:Arial;}
#map{height:100vh;}

.panel{
 position:absolute;
 top:10px; left:10px;
 z-index:5;
 background:white;
 padding:12px;
 border-radius:8px;
 box-shadow:2px 2px 6px #999;
 font-size:13px;
 width:330px;
}

.panel select, .panel input, .panel button{
 width:100%;
 margin-bottom:6px;
}

.stats{
 margin-top:8px;
 font-size:12px;
 max-height:250px;
 overflow:auto;
 display:none;
}

/* ===== DROPDOWN MULTISELECT ===== */
.dropdown{
 position:relative;
}
.dropdown-content{
 display:none;
 position:absolute;
 background:white;
 border:1px solid #ccc;
 max-height:200px;
 overflow:auto;
 width:100%;
 z-index:10;
}
.dropdown.open .dropdown-content{
 display:block;
}
.dropdown button{
 text-align:left;
}
</style>
</head>

<body>

<div class="panel">

<b>üîé Buscador</b>
<input type="text" id="buscador" placeholder="C√≥digo o Raz√≥n Social">
<button onclick="buscar()">Buscar</button>

<hr>

<b>üéõÔ∏è Filtros</b>

<div class="dropdown">
<button onclick="toggleDropdown(this)">Estado ‚ñº</button>
<div class="dropdown-content">
<select id="f_estado" multiple></select>
</div>
</div>

<div class="dropdown">
<button onclick="toggleDropdown(this)">Actividad ‚ñº</button>
<div class="dropdown-content">
<select id="f_actividad" multiple></select>
</div>
</div>

<div class="dropdown">
<button onclick="toggleDropdown(this)">Provincia ‚ñº</button>
<div class="dropdown-content">
<select id="f_provincia" multiple></select>
</div>
</div>

<div class="dropdown">
<button onclick="toggleDropdown(this)">Distrito ‚ñº</button>
<div class="dropdown-content">
<select id="f_distrito" multiple></select>
</div>
</div>

<button onclick="resetFiltros()">Limpiar filtros</button>

<hr>
<button onclick="toggleHeatmap()">üå°Ô∏è Activar / Desactivar Mapa de Calor</button>

<hr>
<div id="contador"></div>

<div class="stats" id="panelStats">
 <div id="stats_actividad"></div>
 <div id="stats_geo"></div>
 <div id="stats_total"></div>
</div>

</div>

<div id="map"></div>

<script>
/* ===== TU SCRIPT ORIGINAL INTACTO ===== */
let map;
let datos=[];
let marcadores=[];
let heatmap;
let heatmapActivo=false;
let filtroTimeout=null;

/* ========= TODO TU C√ìDIGO ORIGINAL DE ACTIVIDADES, COLORES,
   FILTROS, ESTAD√çSTICAS, ETC, SE MANTIENE IGUAL ========= */

/* ================== A√ëADIDOS ================== */

// Ocultar marcadores al inicio
function ocultarMarcadores(){
 marcadores.forEach(m=>m.setMap(null));
}

// Detectar filtros activos
function hayFiltrosActivos(){
 return ["f_estado","f_actividad","f_provincia","f_distrito"]
  .some(id=>document.getElementById(id).selectedOptions.length>0);
}

// Dropdown UI
function toggleDropdown(btn){
 let d=btn.parentElement;
 d.classList.toggle("open");
}

// Buscar con resaltado + radio 100m
function buscar(){
 let texto=document.getElementById("buscador").value.trim().toLowerCase();
 if(texto===""){ resetFiltros(); return; }

 let coincidencias = datos.filter(d =>
   String(d.codigo).toLowerCase().includes(texto) ||
   String(d.razon).toLowerCase().includes(texto)
 );

 if(coincidencias.length===0){
   alert("No se encontraron coincidencias");
   return;
 }

 let visibles = [];

 coincidencias.forEach(c=>{
   datos.forEach(d=>{
     let dist = google.maps.geometry.spherical.computeDistanceBetween(
       new google.maps.LatLng(c.lat,c.lng),
       new google.maps.LatLng(d.lat,d.lng)
     );
     if(dist <= 100) visibles.push(d);
   });
 });

 visibles = [...new Set(visibles)];

 dibujarMarcadores(visibles);

 // Resaltar coincidencias
 marcadores.forEach(m=>{
   let d = visibles.find(v =>
     v.lat===m.getPosition().lat() &&
     v.lng===m.getPosition().lng()
   );
   if(coincidencias.includes(d)){
     m.setIcon({
       path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
       scale:6,
       fillColor:"red",
       fillOpacity:1,
       strokeWeight:1
     });
   }
 });

 construirHeatmap(visibles);
 actualizarContador(visibles);
 actualizarEstadisticas(visibles);

 map.setCenter({lat:coincidencias[0].lat,lng:coincidencias[0].lng});
 map.setZoom(14);
}

/* ===== AJUSTE SOLO AL INIT ===== */
const _initMap = initMap;
initMap = function(){
 _initMap();
 setTimeout(()=>ocultarMarcadores(),500);
};
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization,geometry&callback=initMap" async defer></script>

</body>
</html>































