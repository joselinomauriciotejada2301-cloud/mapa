<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
body{margin:0;font-family:Arial;}
#map{height:100vh;}

.panel{
    position:absolute;
    top:10px; left:10px;
    z-index:5;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:2px 2px 6px #999;
    font-size:13px;
    width:330px;
}

.panel select, .panel input, .panel button{
    width:100%;
    margin-bottom:6px;
}

.stats{
    margin-top:8px;
    font-size:12px;
    max-height:250px;
    overflow:auto;
    display:none;
}
</style>
</head>

<body>

<div class="panel">

<b>üîé Buscador</b>
<input type="text" id="buscador" placeholder="C√≥digo o Raz√≥n Social">
<button onclick="buscar()">Buscar</button>

<hr>

<b>üéõÔ∏è Filtros</b>
<select id="f_estado" multiple></select>
<select id="f_actividad" multiple></select>
<select id="f_provincia" multiple></select>
<select id="f_distrito" multiple></select>

<button onclick="resetFiltros()">Limpiar filtros</button>

<hr>
<button onclick="toggleHeatmap()">üå°Ô∏è Activar / Desactivar Mapa de Calor</button>

<hr>
<div id="contador"></div>

<div class="stats" id="panelStats">
  <div id="stats_actividad"></div>
  <div id="stats_geo"></div>
  <div id="stats_total"></div>
</div>

</div>

<div id="map"></div>

<script>
let map;
let datos=[];
let marcadores=[];
let heatmap;
let heatmapActivo=false;
let filtroTimeout=null;

// ===== ACTIVIDADES =====
const actividadesInfo = {
"030":"030-REFINERIAS TOPPING","034":"034-PLANTAS LUBRICANTES Y GRASAS",
"040":"040-PLANTA DE ABASTECIMIENTO DE COMBUSTIBLES LIQUIDOS",
"050":"050-ESTACI√ìN DE SERVICIOS / GRIFOS",
"051":"051-CONSUMIDOR DIRECTO DE COMBUSTIBLE L√çQUIDO HASTA 5 MB",
"052":"052-CONSUMIDOR DIRECTO DE COMBUSTIBLE L√çQUIDO DE 5 A 50 MB",
"053":"053-CONSUMIDOR DIRECTO DE COMBUSTIBLE L√çQUIDO MAYOR A 50 MB"
};

function colorActividad(act){
 let c = act.substring(0,3);
 const colores = {
  "030":"#8e44ad","034":"#9b59b6","040":"#2980b9","050":"orange",
  "051":"#f39c12","052":"#d35400","053":"#e67e22"
 };
 return colores[c] || "black";
}

// ===== INIT MAP =====
function initMap(){
 map = new google.maps.Map(document.getElementById("map"), {
   center:{lat:-12.05,lng:-77.05},
   zoom:11
 });

 fetch("/datos")
 .then(r=>r.json())
 .then(data=>{
   datos=data;
   cargarFiltros();
   dibujarMarcadores(datos,false); // ‚ùå ocultos al inicio
   construirHeatmap(datos);
   actualizarContador(datos);
 });
}

// ===== HEATMAP =====
function construirHeatmap(lista){
 let puntos = lista.map(d => ({
   location: new google.maps.LatLng(d.lat, d.lng),
   weight: Math.sqrt(d.capacidad || 1)
 }));

 if(heatmap) heatmap.setMap(null);

 heatmap = new google.maps.visualization.HeatmapLayer({
   data: puntos,
   radius: 40
 });
}

// ===== TOGGLE HEATMAP =====
function toggleHeatmap(){
 heatmapActivo = !heatmapActivo;

 if(heatmapActivo){
   heatmap.setMap(map);
   ocultarMarcadores();
 }else{
   heatmap.setMap(null);
   if(hayFiltrosActivos()) mostrarMarcadores();
 }
}

// ===== MARCADORES =====
function dibujarMarcadores(lista,mostrar=true,resaltar=false){
 marcadores.forEach(m=>m.setMap(null));
 marcadores=[];

 lista.forEach(d=>{
   let marker=new google.maps.Marker({
     position:{lat:d.lat,lng:d.lng},
     map: mostrar ? map : null,
     icon:{
       path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
       scale:5,
       fillColor: resaltar ? "yellow" : colorActividad(d.actividad),
       fillOpacity:1,
       strokeWeight:1
     }
   });

   let info=new google.maps.InfoWindow({
     content:`<b>${d.razon}</b><br>C√≥digo: ${d.codigo}`
   });

   marker.addListener("click",()=>info.open(map,marker));
   marcadores.push(marker);
 });
}

function ocultarMarcadores(){
 marcadores.forEach(m=>m.setMap(null));
}

function mostrarMarcadores(){
 marcadores.forEach(m=>m.setMap(map));
}

function hayFiltrosActivos(){
 return ["f_estado","f_actividad","f_provincia","f_distrito"]
  .some(id=>document.getElementById(id).selectedOptions.length>0);
}

// ===== CONTADOR =====
function actualizarContador(lista){
 document.getElementById("contador").innerHTML =
  "Total registros: <b>"+lista.length+"</b>";
}

// ===== FILTROS =====
function cargarFiltros(){
 ["estado","actividad","provincia","distrito"].forEach(c=>llenar("f_"+c,c));
}

function llenar(id,campo){
 let sel=document.getElementById(id);
 sel.innerHTML="";
 [...new Set(datos.map(d=>d[campo]))].sort().forEach(v=>{
   if(v){
     let op=document.createElement("option");
     op.value=v; op.text=v;
     sel.add(op);
   }
 });
 sel.addEventListener("change",()=>{
   clearTimeout(filtroTimeout);
   filtroTimeout=setTimeout(aplicarFiltros,200);
 });
}

// ===== APLICAR FILTROS =====
function aplicarFiltros(){
 let filtrados = datos.filter(d =>
   (!valores("f_estado").length || valores("f_estado").includes(d.estado)) &&
   (!valores("f_actividad").length || valores("f_actividad").includes(d.actividad)) &&
   (!valores("f_provincia").length || valores("f_provincia").includes(d.provincia)) &&
   (!valores("f_distrito").length || valores("f_distrito").includes(d.distrito))
 );

 dibujarMarcadores(filtrados,true);
 construirHeatmap(filtrados);
 actualizarContador(filtrados);
 actualizarEstadisticas(filtrados);

 if(heatmapActivo) heatmap.setMap(map);
}

// ===== BUSCADOR =====
function buscar(){
 let texto=document.getElementById("buscador").value.toLowerCase().trim();
 if(!texto){ resetFiltros(); return; }

 let res=datos.filter(d =>
   String(d.codigo).toLowerCase().includes(texto) ||
   String(d.razon).toLowerCase().includes(texto)
 );

 if(!res.length){ alert("No se encontraron coincidencias"); return; }

 dibujarMarcadores(res,true,true);
 construirHeatmap(res);
 actualizarContador(res);
 map.setCenter({lat:res[0].lat,lng:res[0].lng});
 map.setZoom(res.length===1?15:12);
}

// ===== RESET =====
function resetFiltros(){
 document.querySelectorAll("select").forEach(s=>s.selectedIndex=-1);
 ocultarMarcadores();
 construirHeatmap(datos);
 actualizarContador(datos);
 document.getElementById("panelStats").style.display="none";
 if(heatmapActivo) heatmap.setMap(map);
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization&callback=initMap" async defer></script>

</body>
</html>





























