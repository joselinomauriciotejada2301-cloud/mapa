<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa Osinergmin</title>
<style>
  body { margin:0; font-family: Arial; }
  #map { height: 90vh; width: 100%; }
  #panel {
    padding:10px;
    background:#f4f4f4;
  }
  select, input, button {
    padding:5px;
    margin:3px;
  }
  #leyenda {
    padding:10px;
    background:white;
    max-height:200px;
    overflow:auto;
    font-size:14px;
  }
</style>
</head>
<body>

<div id="panel">
  <input type="text" id="buscador" placeholder="Buscar Razón Social o Código">
  <button onclick="buscar()">Buscar</button>

  <select id="filtroProvincia" onchange="aplicarFiltros()" multiple></select>
  <select id="filtroDistrito" onchange="aplicarFiltros()" multiple></select>
  <select id="filtroActividad" onchange="aplicarFiltros()" multiple></select>

  <span id="contador"></span>
</div>

<div id="map"></div>
<div id="leyenda"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY"></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
let map;
let datos = [];
let marcadores = [];
let markerCluster = null;

// =====================
// COLORES POR ACTIVIDAD
// =====================
const actividadesPermitidas = [
"030-REFINERIAS TOPPING",
"034-PLANTAS LUBRICANTES Y GRASAS",
"040-PLANTA DE ABASTECIMIENTO DE COMBUSTIBLES LIQUIDOS",
"050-ESTACIÓN DE SERVICIOS / GRIFOS",
"051-CONSUMIDOR DIRECTO DE COMBUSTIBLE LÍQUIDO CON CAPACIDAD HASTA 5 MB",
"052-CONSUMIDOR DIRECTO DE COMBUSTIBLE LÍQUIDO CON CAPACIDAD DE 5 A 50 MB",
"053-CONSUMIDOR DIRECTO DE COMBUSTIBLE LÍQUIDO CON CAPACIADAD MAYOR A 50 MB",
"056-ESTACIÓN DE SERVICIO CON GASOCENTRO DE GLP",
"070-PLANTAS ENVASADORAS GLP",
"071-GASOCENTROS DE GLP",
"074-LOCALES DE VENTA DE GLP EN CILINDROS CON CAPACIDAD MENOR O IGUAL A 5,000 KG",
"078-LOCALES DE VENTA DE GLP EN CILINDROS CON CAPACIDAD MAYOR A 5,000 KG",
"101-CONSUMIDOR DIRECTO DE GNV",
"102-ESTABLECIMIENTO DE VENTA AL PUBLICO DE GNV",
"106-EE.SS con GNV",
"107-EE.SS con GLP y GNV",
"112-CONSUMIDOR DIRECTO DE OPDH Y COMBUSTIBLE LÍQUIDO CON CAPACIDAD HASTA 5 MB",
"114-CONSUMIDOR DIRECTO DE OPDH Y COMBUSTIBLE LÍQUIDO CON CAPACIDAD DE 5 A 50 MB",
"115-CONSUMIDORES DIRECTOS DE OTROS PRODUCTOS DERIVADOS DE LOS HIDROCARBUROS",
"190-ESTABLECIMIENTO DESTINADO AL SUMINISTRO DE GNV EN SISTEMAS INTEGRADOS DE TRANSPORTE",
"300-PROCES GNL",
"320-GASOCENTRO DE GLP CON ESTABLECIMIENTO DE VENTA AL PUBLICO DE GNV",
"400-CONSUMIDORES DIRECTOS DE GLP CON CAPACIDAD MENOR O IGUAL A 1000 GLN",
"401-CONSUMIDORES DIRECTOS DE GLP CON CAPACIDAD MAYOR A 1000 GLN",
"600-REDES DE DISTRIBUCIÓN DE GLP CON CAPACIDAD MENOR O IGUAL A 1000 GLN",
"601-REDES DE DISTRIBUCIÓN DE GLP CON CAPACIDAD MAYOR A 1000 GLN",
"607-ESTACION DE COMPRESIÓN DE GAS NATURAL",
"613-ESTACIÓN DE CARGA DE GNL",
"618-ESTACIÓN DE CARGA DE GNC",
"975-CONSUMIDORES DIRECTOS CON INSTALACIONES ESTRATEGICAS",
"982-CONSUMIDOR DIRECTO CON INSTALACIONES ESTRATEGICAS DE GLP CON CAPACIDAD MAYOR A 1000 GLN",
"983-CONSUMIDOR DIRECTO CON INSTALACIONES ESTRATEGICAS TEMPORALES",
"984-CONSUMIDOR DIRECTO CON INSTALACIONES ESTRATEGICAS DE GLP CON CAPACIDAD MENOR O IGUAL A 1000 GLN"
];

const colores = {};
actividadesPermitidas.forEach((a,i)=>{
  colores[a] = `hsl(${(i*37)%360},70%,50%)`;
});

function colorActividad(act){
  return colores[act] || "#999";
}

// =====================
// CARGA DE DATOS
// =====================
fetch("datos.json")
.then(r=>r.json())
.then(json=>{
  datos = json.filter(d=>actividadesPermitidas.includes(d.actividad));
  iniciarMapa();
  cargarFiltros();
  dibujarMarcadores(datos);
});

// =====================
function iniciarMapa(){
  map = new google.maps.Map(document.getElementById("map"),{
    center:{lat:-9.19,lng:-75.02},
    zoom:6
  });
}

// =====================
function cargarFiltros(){
  cargarOpciones("filtroProvincia",[...new Set(datos.map(d=>d.provincia))]);
  cargarOpciones("filtroDistrito",[...new Set(datos.map(d=>d.distrito))]);
  cargarOpciones("filtroActividad",actividadesPermitidas);
}

function cargarOpciones(id,lista){
  const sel=document.getElementById(id);
  lista.sort().forEach(v=>{
    let op=document.createElement("option");
    op.value=v;
    op.textContent=v;
    sel.appendChild(op);
  });
}

// =====================
function obtenerSeleccion(id){
  return [...document.getElementById(id).selectedOptions].map(o=>o.value);
}

// =====================
function aplicarFiltros(){
  let prov = obtenerSeleccion("filtroProvincia");
  let dist = obtenerSeleccion("filtroDistrito");
  let act = obtenerSeleccion("filtroActividad");

  let filtrado = datos.filter(d=>{
    return (prov.length==0 || prov.includes(d.provincia)) &&
           (dist.length==0 || dist.includes(d.distrito)) &&
           (act.length==0 || act.includes(d.actividad));
  });

  dibujarMarcadores(filtrado);
  actualizarLeyenda(filtrado);
}

// =====================
// DIBUJO OPTIMIZADO
// =====================
function dibujarMarcadores(lista){

 if(markerCluster){
   markerCluster.clearMarkers();
 }
 marcadores.forEach(m=>m.setMap(null));
 marcadores=[];

 let i=0;
 const batch=500;

 function crearLote(){
   const nuevos=[];

   for(let j=0;j<batch && i<lista.length;j++,i++){
     const d=lista[i];

     let marker = new google.maps.Marker({
       position:{lat:d.lat,lng:d.lng},
       icon:{
         path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
         scale:5,
         fillColor: colorActividad(d.actividad),
         fillOpacity:1,
         strokeWeight:1
       }
     });

     let info = new google.maps.InfoWindow({
       content:`
        <b>${d.razon}</b><br>
        Código Osinergmin: ${d.codigo}<br>
        Registro: ${d.registro}<br>
        Estado: ${d.estado}<br>
        Capacidad: ${d.capacidad}<br>
        Última fiscalización: ${d.fiscalizacion}
       `
     });

     marker.addListener("click",()=>info.open(map,marker));

     nuevos.push(marker);
     marcadores.push(marker);
   }

   if(!markerCluster){
     markerCluster = new markerClusterer.MarkerClusterer({
       map,
       markers:nuevos
     });
   } else {
     markerCluster.addMarkers(nuevos);
   }

   if(i<lista.length){
     requestAnimationFrame(crearLote);
   } else {
     document.getElementById("contador").innerHTML =
       "Total: <b>"+lista.length+"</b>";
   }
 }

 crearLote();
}

// =====================
function actualizarLeyenda(lista){
  const ley = document.getElementById("leyenda");
  ley.innerHTML="<b>Por actividad</b><br>";

  const conteo={};
  lista.forEach(d=>{
    conteo[d.actividad]=(conteo[d.actividad]||0)+1;
  });

  Object.keys(conteo).forEach(act=>{
    ley.innerHTML += `
      <div>
        <span style="display:inline-block;width:12px;height:12px;background:${colorActividad(act)}"></span>
        ${act}: <b>${conteo[act]}</b>
      </div>
    `;
  });

  ley.innerHTML += `<hr>Total: <b>${lista.length}</b>`;
}

// =====================
// BUSCADOR (queda igual que tu versión actual)
function buscar(){
  alert("Buscador pendiente de ajuste (como acordamos no se modifica aún).");
}

</script>
</body>
</html>













