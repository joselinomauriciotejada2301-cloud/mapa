<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
body{margin:0;font-family:Arial;}
#map{height:100vh;}

.panel{
    position:absolute;
    top:10px; left:10px;
    z-index:5;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:2px 2px 6px #999;
    font-size:13px;
    width:320px;
}

.panel select, .panel input, .panel button{
    width:100%;
    margin-bottom:6px;
}

.stats{
    margin-top:8px;
    font-size:12px;
    max-height:250px;
    overflow:auto;
    display:none;
}
</style>
</head>

<body>

<div class="panel">

<b>üîé Buscador</b>
<input type="text" id="buscador" placeholder="C√≥digo o Raz√≥n Social">
<button onclick="buscar()">Buscar</button>

<hr>

<b>üéõÔ∏è Filtros</b>
<select id="f_estado" multiple></select>
<select id="f_actividad" multiple></select>
<select id="f_provincia" multiple></select>
<select id="f_distrito" multiple></select>
<button onclick="resetFiltros()">Limpiar filtros</button>

<hr>
<button onclick="toggleHeatmap()">üå°Ô∏è Activar / Desactivar Mapa de Calor</button>

<hr>
<div id="contador"></div>

<div class="stats" id="panelStats">
  <div id="stats_actividad"></div>
  <div id="stats_geo"></div>
  <div id="stats_total"></div>
</div>

</div>

<div id="map"></div>

<script>
let map;
let datos=[];
let marcadores=[];
let heatmap;
let heatmapActivo=false;
let filtroTimeout=null;

// ===== MAP INIT =====
function initMap(){
 map = new google.maps.Map(document.getElementById("map"), {
   center:{lat:-12.05,lng:-77.05},
   zoom:11
 });

 fetch("/datos")
 .then(r=>r.json())
 .then(data=>{
   datos=data;
   cargarFiltros();
   dibujarMarcadores(datos);
   construirHeatmap(datos);

   document.getElementById("contador").innerHTML =
    "Total registros: <b>"+datos.length+"</b>";
 });
}

// ===== CREAR HEATMAP =====
function construirHeatmap(lista){
 let puntos = lista.map(d => ({
   location: new google.maps.LatLng(d.lat, d.lng),
   weight: Math.sqrt(d.capacidad || 1)
 }));

 if(heatmap){ heatmap.setMap(null); }

 heatmap = new google.maps.visualization.HeatmapLayer({
   data: puntos,
   radius: 35
 });
}

// ===== TOGGLE HEATMAP =====
function toggleHeatmap(){
 heatmapActivo = !heatmapActivo;

 if(heatmapActivo){
   heatmap.setMap(map);
   marcadores.forEach(m=>m.setMap(null));
 } else {
   heatmap.setMap(null);
   marcadores.forEach(m=>m.setMap(map));
 }
}

// ===== MARCADORES POR LOTES =====
function dibujarMarcadores(lista){
 marcadores.forEach(m=>m.setMap(null));
 marcadores=[];

 let i=0;
 const batch=400;

 function crearLote(){
   for(let j=0;j<batch && i<lista.length;j++,i++){
     let d=lista[i];

     let marker=new google.maps.Marker({
       position:{lat:d.lat,lng:d.lng},
       map:map
     });

     let info=new google.maps.InfoWindow({
       content:`<b>${d.razon}</b><br>
       C√≥digo: ${d.codigo}<br>
       Capacidad: ${d.capacidad}`
     });

     marker.addListener("click",()=>info.open(map,marker));
     marcadores.push(marker);
   }

   if(i<lista.length) requestAnimationFrame(crearLote);
 }
 crearLote();
}

// ===== FILTROS =====
function cargarFiltros(){
 llenar("f_estado","estado");
 llenar("f_actividad","actividad");
 llenar("f_provincia","provincia");
 llenar("f_distrito","distrito");
}

function llenar(id,campo){
 let sel=document.getElementById(id);
 sel.innerHTML="";
 let vals=[...new Set(datos.map(d=>d[campo]))].sort();
 vals.forEach(v=>{
   if(v){
     let op=document.createElement("option");
     op.value=v; op.text=v;
     sel.add(op);
   }
 });
 sel.addEventListener("change", ()=>{
   clearTimeout(filtroTimeout);
   filtroTimeout=setTimeout(aplicarFiltros,200);
 });
}

function valores(id){
 return Array.from(document.getElementById(id).selectedOptions)
  .map(o=>o.value);
}

function aplicarFiltros(){
 let est=valores("f_estado");
 let act=valores("f_actividad");
 let prov=valores("f_provincia");
 let dist=valores("f_distrito");

 let filtrados = datos.filter(d =>
   (est.length==0 || est.includes(d.estado)) &&
   (act.length==0 || act.includes(d.actividad)) &&
   (prov.length==0 || prov.includes(d.provincia)) &&
   (dist.length==0 || dist.includes(d.distrito))
 );

 dibujarMarcadores(filtrados);
 construirHeatmap(filtrados);

 if(heatmapActivo){
   heatmap.setMap(map);
 } 
}

// ===== BUSCADOR =====
function buscar(){
 let t=document.getElementById("buscador").value.toLowerCase();
 let e=datos.find(d =>
   d.codigo.toLowerCase().includes(t) ||
   d.razon.toLowerCase().includes(t)
 );
 if(e){
   map.setCenter({lat:e.lat,lng:e.lng});
   map.setZoom(15);
 } else alert("No encontrado");
}

// ===== RESET =====
function resetFiltros(){
 document.querySelectorAll("select").forEach(s=>s.selectedIndex=-1);
 dibujarMarcadores(datos);
 construirHeatmap(datos);
 if(heatmapActivo) heatmap.setMap(map);

 document.getElementById("contador").innerHTML =
  "Total registros: <b>"+datos.length+"</b>";
}
</script>

<!-- üîë Reemplaza TU_API_KEY por tu API Key -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization&callback=initMap" async defer></script>

</body>
</html>




















