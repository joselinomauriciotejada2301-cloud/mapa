<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
body{margin:0;font-family:Arial;}
#map{height:100vh;}

.panel{
    position:absolute;
    top:10px; left:10px;
    z-index:5;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:2px 2px 6px #999;
    font-size:13px;
    width:310px;
}

.panel select, .panel input, .panel button{
    width:100%;
    margin-bottom:6px;
}

.stats{
    margin-top:8px;
    font-size:12px;
    max-height:220px;
    overflow:auto;
    display:none;
}
</style>
</head>

<body>

<div class="panel">

<b>üîé Buscador</b>
<input type="text" id="buscador" placeholder="C√≥digo o Raz√≥n Social">
<button onclick="buscar()">Buscar</button>

<hr>

<b>üéõÔ∏è Filtros (Ctrl + click m√∫ltiple)</b>

<select id="f_estado" multiple></select>
<select id="f_actividad" multiple></select>
<select id="f_provincia" multiple></select>
<select id="f_distrito" multiple></select>

<button onclick="resetFiltros()">Limpiar filtros</button>

<hr>
<div id="contador"></div>

<div class="stats" id="panelStats">
<div id="stats_actividad"></div>
<div id="stats_geo"></div>
<div id="stats_total"></div>
</div>

</div>

<div id="map"></div>

<script>
let map;
let datos=[];
let marcadores=[];
let filtroTimeout=null;

// ===== COLORES POR ACTIVIDAD =====
function colorActividad(act){
    let c = act.substring(0,3);
    const colores = {
      "030":"#8e44ad","034":"#9b59b6","040":"#2980b9","050":"orange",
      "051":"#f39c12","052":"#d35400","053":"#e67e22","056":"blue",
      "070":"#16a085","071":"red","074":"#27ae60","078":"#2ecc71",
      "101":"#1abc9c","102":"green","106":"darkgreen","107":"violet",
      "112":"#7f8c8d","114":"#95a5a6","115":"#34495e","190":"#c0392b",
      "300":"#6c3483","320":"brown","400":"#f1c40f","401":"#f39c12",
      "600":"#2980b9","601":"#1f618d","607":"#17a589","613":"#48c9b0",
      "618":"#45b39d","975":"#922b21","982":"#641e16","983":"#7b241c",
      "984":"#943126"
    };
    return colores[c] || "black";
}

// ===== INIT MAP =====
function initMap(){
    map = new google.maps.Map(document.getElementById("map"), {
        center:{lat:-12.05,lng:-77.05},
        zoom:11
    });

    fetch("/datos")
    .then(r=>r.json())
    .then(data=>{
        datos=data;
        cargarFiltros();
        dibujarMarcadores(datos);
        document.getElementById("contador").innerHTML =
          "Total registros: <b>"+datos.length+"</b>";
    });

    // eventos filtros con debounce
    ["f_estado","f_actividad","f_provincia","f_distrito"]
      .forEach(id=>{
        document.getElementById(id)
        .addEventListener("change", ()=> {
            clearTimeout(filtroTimeout);
            filtroTimeout=setTimeout(aplicarFiltros,200);
        });
      });
}

// ===== DIBUJA MARCADORES =====
function dibujarMarcadores(lista){
    marcadores.forEach(m=>m.setMap(null));
    marcadores=[];

    lista.forEach(d=>{
        let marker=new google.maps.Marker({
            position:{lat:d.lat,lng:d.lng},
            map:map,
            icon:{
              path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
              scale:5,
              fillColor:colorActividad(d.actividad),
              fillOpacity:1,
              strokeWeight:1
            }
        });

        let info=new google.maps.InfoWindow({
          content:`<div style="font-size:13px">
          <b>${d.razon}</b><br>
          C√≥digo: ${d.codigo}<br>
          Actividad: ${d.actividad}<br>
          Estado: ${d.estado}
          </div>`
        });

        marker.addListener("click",()=>info.open(map,marker));
        marcadores.push(marker);
    });

    document.getElementById("contador").innerHTML =
      "Total: <b>"+lista.length+"</b>";
}

// ===== CARGAR FILTROS =====
function cargarFiltros(){
    llenar("f_estado","estado");
    llenar("f_actividad","actividad");
    llenar("f_provincia","provincia");
    llenar("f_distrito","distrito");
}

function llenar(id,campo){
    let sel=document.getElementById(id);
    sel.innerHTML="";
    let vals=[...new Set(datos.map(d=>d[campo]))].sort();
    vals.forEach(v=>{
        if(v){
            let op=document.createElement("option");
            op.value=v; op.text=v;
            sel.add(op);
        }
    });
}

function valores(id){
    return Array.from(document.getElementById(id).selectedOptions)
           .map(o=>o.value);
}

// ===== APLICAR FILTROS =====
function aplicarFiltros(){

    let est=valores("f_estado");
    let act=valores("f_actividad");
    let prov=valores("f_provincia");
    let dist=valores("f_distrito");

    let filtrados = datos.filter(d =>
        (est.length==0 || est.includes(d.estado)) &&
        (act.length==0 || act.includes(d.actividad)) &&
        (prov.length==0 || prov.includes(d.provincia)) &&
        (dist.length==0 || dist.includes(d.distrito))
    );

    dibujarMarcadores(filtrados);
    actualizarEstadisticas(filtrados, prov);

    if(filtrados.length>0){
        map.setCenter({lat:filtrados[0].lat,lng:filtrados[0].lng});
    }
}

// ===== ESTADISTICAS OPTIMIZADAS =====
function actualizarEstadisticas(lista, provinciasSeleccionadas){

    let panel=document.getElementById("panelStats");

    if(lista.length===datos.length){
        panel.style.display="none";
        return;
    }
    panel.style.display="block";

    // --- actividad ---
    let porAct={};
    lista.forEach(d=>{
        let c=d.actividad.substring(0,3);
        porAct[c]=(porAct[c]||0)+1;
    });

    let htmlAct="<b>üìå Por Actividad</b><br>";
    for(let a in porAct){
        htmlAct+=`${a}: ${porAct[a]}<br>`;
    }
    document.getElementById("stats_actividad").innerHTML=htmlAct;

    // --- geo ---
    let porGeo={};

    if(provinciasSeleccionadas.length>0){
        lista.forEach(d=>{
            porGeo[d.distrito]=(porGeo[d.distrito]||0)+1;
        });
        let h="<br><b>üèòÔ∏è Por Distrito</b><br>";
        for(let g in porGeo){h+=`${g}: ${porGeo[g]}<br>`;}
        document.getElementById("stats_geo").innerHTML=h;
    } else {
        lista.forEach(d=>{
            porGeo[d.provincia]=(porGeo[d.provincia]||0)+1;
        });
        let h="<br><b>üó∫Ô∏è Por Provincia</b><br>";
        for(let g in porGeo){h+=`${g}: ${porGeo[g]}<br>`;}
        document.getElementById("stats_geo").innerHTML=h;
    }

    document.getElementById("stats_total").innerHTML =
      "<br><b>Total general: "+lista.length+"</b>";
}

// ===== BUSCADOR =====
function buscar(){
    let t=document.getElementById("buscador").value.toLowerCase();
    let e=datos.find(d =>
        d.codigo.toLowerCase().includes(t) ||
        d.razon.toLowerCase().includes(t)
    );
    if(e){
        map.setCenter({lat:e.lat,lng:e.lng});
        map.setZoom(15);
    } else alert("No encontrado");
}

// ===== RESET =====
function resetFiltros(){
    document.querySelectorAll("select").forEach(s=>s.selectedIndex=-1);
    dibujarMarcadores(datos);
    document.getElementById("panelStats").style.display="none";
    document.getElementById("contador").innerHTML =
      "Total registros: <b>"+datos.length+"</b>";
}
</script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&callback=initMap" async defer></script>

</body>
</html>







