<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
body{margin:0;font-family:Arial;}
#map{height:100vh;}

.panel{
    position:absolute;
    top:10px;
    left:10px;
    z-index:5;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:2px 2px 6px #999;
    font-size:13px;
    width:270px;
}

.panel select, .panel input, .panel button{
    width:100%;
    margin-bottom:6px;
}

.leyenda{
    margin-top:8px;
    font-size:12px;
}

.colorBox{
    display:inline-block;
    width:12px;
    height:12px;
    margin-right:6px;
}
.stats{
    margin-top:8px;
    font-size:12px;
    max-height:120px;
    overflow:auto;
}
</style>
</head>

<body>

<div class="panel">
<b>üîé Buscador</b>
<input type="text" id="buscador" placeholder="C√≥digo o Raz√≥n Social">
<button onclick="buscar()">Buscar</button>

<hr>

<b>üéõÔ∏è Filtros</b>
<select id="f_estado" onchange="aplicarFiltros()">
<option value="">-- Estado --</option>
</select>

<select id="f_actividad" onchange="aplicarFiltros()">
<option value="">-- Actividad --</option>
</select>

<select id="f_provincia" onchange="aplicarFiltros()">
<option value="">-- Provincia --</option>
</select>

<select id="f_distrito" onchange="aplicarFiltros()">
<option value="">-- Distrito --</option>
</select>

<hr>
<div id="contador"></div>

<!-- ===== LEYENDA ===== -->
<div class="leyenda">
<b>üó∫Ô∏è Leyenda de Actividades</b><br>
<div><span class="colorBox" style="background:orange"></span>050 - Estaci√≥n de Servicios</div>
<div><span class="colorBox" style="background:blue"></span>056 - Estaci√≥n con Gasocentro GLP</div>
<div><span class="colorBox" style="background:purple"></span>057 - Grifos Rurales</div>
<div><span class="colorBox" style="background:gray"></span>058 - Grifos Flotantes</div>
<div><span class="colorBox" style="background:red"></span>071 - Gasocentro GLP</div>
<div><span class="colorBox" style="background:green"></span>102 - Venta P√∫blica GNV</div>
<div><span class="colorBox" style="background:darkgreen"></span>106 - Estaci√≥n con GNV</div>
<div><span class="colorBox" style="background:violet"></span>107 - Estaci√≥n GLP y GNV</div>
<div><span class="colorBox" style="background:brown"></span>320 - GLP + Venta GNV</div>
</div>

<!-- ===== ESTAD√çSTICAS ===== -->
<div class="stats">
<b>üìä Estad√≠sticas visibles</b>
<div id="stats_provincia"></div>
<div id="stats_distrito"></div>
</div>

</div>

<div id="map"></div>

<script>
let map;
let datos = [];
let marcadores = [];

// ===== COLORES POR ACTIVIDAD =====
function colorActividad(act){
    act = act.toUpperCase();
    if(act.includes("050")) return "orange";
    if(act.includes("056")) return "blue";
    if(act.includes("057")) return "purple";
    if(act.includes("058")) return "gray";
    if(act.includes("071")) return "red";
    if(act.includes("102")) return "green";
    if(act.includes("106")) return "darkgreen";
    if(act.includes("107")) return "violet";
    if(act.includes("320")) return "brown";
    return "black";
}

// ===== INICIAR MAPA =====
function initMap(){
    map = new google.maps.Map(document.getElementById("map"), {
        center:{lat:-12.05, lng:-77.05},
        zoom:11
    });

    fetch("/datos")
    .then(res => res.json())
    .then(data => {
        datos = data;
        cargarFiltros();
        dibujarMarcadores(datos);
        actualizarEstadisticas(datos);
    });
}

// ===== DIBUJAR MARCADORES =====
function dibujarMarcadores(lista){

    marcadores.forEach(m => m.setMap(null));
    marcadores = [];

    lista.forEach(d => {

        let marker = new google.maps.Marker({
            position:{lat:d.lat, lng:d.lng},
            map:map,
            title:d.razon,
            icon:{
              path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
              scale:5,
              fillColor: colorActividad(d.actividad),
              fillOpacity:1,
              strokeWeight:1
            }
        });

        let info = new google.maps.InfoWindow({
            content:`
            <div style="font-size:13px">
            <b>Raz√≥n Social:</b> ${d.razon}<br>
            <b>C√≥digo Osinergmin:</b> ${d.codigo}<br>
            <b>Registro Hidrocarburos:</b> ${d.registro}<br>
            <b>Actividad:</b> ${d.actividad}<br>
            <b>Capacidad:</b> ${d.capacidad}<br>
            <b>√öltima Fiscalizaci√≥n:</b> ${d.fiscalizacion}<br>
            <b>Estado:</b> ${d.estado}
            </div>`
        });

        marker.addListener("click", ()=>info.open(map,marker));

        marcadores.push(marker);
    });

    document.getElementById("contador").innerHTML =
        "Registros visibles: <b>"+lista.length+"</b>";
}

// ===== CARGAR COMBOS =====
function cargarFiltros(){

    function llenar(id, campo){
        let select = document.getElementById(id);
        let valores = [...new Set(datos.map(d => d[campo]))].sort();
        valores.forEach(v=>{
            if(v){
                let op = document.createElement("option");
                op.value = v;
                op.text = v;
                select.add(op);
            }
        });
    }

    llenar("f_estado","estado");
    llenar("f_actividad","actividad");
    llenar("f_provincia","provincia");
    llenar("f_distrito","distrito");

    document.getElementById("contador").innerHTML =
        "Registros totales: <b>"+datos.length+"</b>";
}

// ===== APLICAR FILTROS =====
function aplicarFiltros(){

    let est = document.getElementById("f_estado").value;
    let act = document.getElementById("f_actividad").value;
    let prov = document.getElementById("f_provincia").value;
    let dist = document.getElementById("f_distrito").value;

    let filtrados = datos.filter(d =>
        (est=="" || d.estado==est) &&
        (act=="" || d.actividad==act) &&
        (prov=="" || d.provincia==prov) &&
        (dist=="" || d.distrito==dist)
    );

    dibujarMarcadores(filtrados);
    actualizarEstadisticas(filtrados);

    if(filtrados.length>0){
        map.setCenter({lat:filtrados[0].lat, lng:filtrados[0].lng});
        map.setZoom(12);
    }
}

// ===== BUSCADOR =====
function buscar(){
    let texto = document.getElementById("buscador").value.toLowerCase();

    let encontrado = datos.find(d =>
        d.codigo.toLowerCase().includes(texto) ||
        d.razon.toLowerCase().includes(texto)
    );

    if(encontrado){
        map.setCenter({lat:encontrado.lat, lng:encontrado.lng});
        map.setZoom(16);

        marcadores.forEach(m=>{
            let pos = m.getPosition();
            if(pos.lat()==encontrado.lat && pos.lng()==encontrado.lng){
                google.maps.event.trigger(m,"click");
            }
        });
    } else {
        alert("No encontrado");
    }
}

// ===== ESTAD√çSTICAS =====
function actualizarEstadisticas(lista){

    let porProvincia = {};
    let porDistrito = {};

    lista.forEach(d=>{
        porProvincia[d.provincia] = (porProvincia[d.provincia] || 0) + 1;
        porDistrito[d.distrito] = (porDistrito[d.distrito] || 0) + 1;
    });

    let htmlProv = "<b>Por Provincia:</b><br>";
    for (let p in porProvincia){
        htmlProv += `${p}: ${porProvincia[p]}<br>`;
    }

    let htmlDist = "<br><b>Por Distrito:</b><br>";
    for (let d in porDistrito){
        htmlDist += `${d}: ${porDistrito[d]}<br>`;
    }

    document.getElementById("stats_provincia").innerHTML = htmlProv;
    document.getElementById("stats_distrito").innerHTML = htmlDist;
}
</script>

<!-- ==== GOOGLE MAPS API ==== -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&callback=initMap" async defer></script>

</body>
</html>
