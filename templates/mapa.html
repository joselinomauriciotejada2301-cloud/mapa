<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
html, body { height:100%; margin:0; font-family:Arial; }
#map { height:100%; }

.panel{
 position:absolute; top:10px; left:10px; z-index:5;
 background:white; padding:12px; border-radius:8px;
 box-shadow:2px 2px 6px #999; width:330px; font-size:13px;
}

.panel select, .panel input, .panel button{
 width:100%; margin-bottom:6px;
}

.panel select{ height:28px; }

.stats{
 margin-top:8px; font-size:12px;
 max-height:250px; overflow:auto; display:none;
}

.legend{ display:none; }

.color-box{
 display:inline-block;
 width:10px;
 height:10px;
 margin-right:6px;
 border-radius:2px;
}
</style>
</head>

<body>

<div class="panel">
<b>üîé Buscador</b>
<input type="text" id="buscador" placeholder="C√≥digo o Raz√≥n Social">
<button onclick="buscar()">Buscar</button>

<hr>

<b>üéõÔ∏è Filtros (Ctrl / Shift m√∫ltiple)</b>
<select id="f_estado" multiple size="1"></select>
<select id="f_actividad" multiple size="1"></select>
<select id="f_provincia" multiple size="1"></select>
<select id="f_distrito" multiple size="1"></select>
<select id="f_anio" multiple size="1"></select>

<button onclick="resetFiltros()">Limpiar filtros</button>

<hr>
<button onclick="toggleHeatmap()">üî• Activar / Desactivar Mapa de Calor</button>

<hr>
<div id="contador"></div>

<div class="stats" id="panelStats">
 <div id="stats_actividad"></div>
 <div id="stats_geo"></div>
 <div id="stats_total"></div>
</div>

</div>

<div id="map"></div>

<script>
let map, datos=[], marcadores=[], heatmap;
let heatmapActivo=false;
let modoBusqueda=false;

/* ========= COLORES POR ACTIVIDAD ========= */
const paletaColores=[
 "#e74c3c","#3498db","#2ecc71","#f1c40f","#9b59b6",
 "#1abc9c","#e67e22","#34495e","#d35400","#16a085"
];
const colorActividadMap={};

function colorPorActividad(act){
 if(!colorActividadMap[act]){
  const i=Object.keys(colorActividadMap).length % paletaColores.length;
  colorActividadMap[act]=paletaColores[i];
 }
 return colorActividadMap[act];
}

/* ===== MAPA ===== */
function initMap(){
 map=new google.maps.Map(document.getElementById("map"),{
  center:{lat:-12.05,lng:-77.05}, zoom:11
 });

 fetch("/datos").then(r=>r.json()).then(d=>{
  datos=d.map(x=>{
   if(x.fiscalizacion){
    let partes=x.fiscalizacion.split("/");
    x._anioFiscalizacion = partes[2];
   }
   return x;
  });

  cargarFiltros();
  dibujarMarcadores(datos);
  construirHeatmap(datos);
  actualizarContador(datos);
  ocultarMarcadores();
 });
}

/* ===== HEATMAP ===== */
function construirHeatmap(lista){
 let puntos=lista.map(d=>({
  location:new google.maps.LatLng(d.lat,d.lng),
  weight:Math.sqrt(d.capacidad||1)
 }));
 if(heatmap) heatmap.setMap(null);
 heatmap=new google.maps.visualization.HeatmapLayer({
  data:puntos, radius:40
 });
 if(heatmapActivo) heatmap.setMap(map);
}

function toggleHeatmap(){
 heatmapActivo=!heatmapActivo;
 heatmap.setMap(heatmapActivo?map:null);
}

/* ===== MARCADORES ===== */
function dibujarMarcadores(lista){
 marcadores.forEach(m=>m.setMap(null));
 marcadores=[];

 lista.forEach(d=>{
  let icono = modoBusqueda ? {
   path:google.maps.SymbolPath.STAR,
   scale:7,
   fillColor:"#000",
   fillOpacity:1,
   strokeWeight:1
  } : {
   path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
   scale:5,
   fillColor:colorPorActividad(d.actividad),
   fillOpacity:1,
   strokeWeight:1
  };

  let marker=new google.maps.Marker({
   position:{lat:d.lat,lng:d.lng},
   map:map,
   icon:icono
  });

  let info=new google.maps.InfoWindow({
   content:`
   <b>${d.razon}</b><br>
   C√≥digo: ${d.codigo}<br>
   Registro: ${d.registro}<br>
   Distrito: ${d.distrito}<br>
   Estado: ${d.estado}<br>
   Capacidad: ${d.capacidad}<br>
   √öltima fiscalizaci√≥n: ${d.fiscalizacion}`
  });

  marker.addListener("click",()=>info.open(map,marker));
  marcadores.push(marker);
 });
}

function ocultarMarcadores(){ marcadores.forEach(m=>m.setMap(null)); }
function mostrarMarcadores(){ marcadores.forEach(m=>m.setMap(map)); }

/* ===== FILTROS ===== */
function cargarFiltros(){
 ["estado","actividad","provincia","distrito"].forEach(c=>{
  let s=document.getElementById("f_"+c);
  [...new Set(datos.map(d=>d[c]))].sort().forEach(v=>{
   if(v){
    let o=document.createElement("option");
    o.value=v;o.text=v;s.add(o);
   }
  });
  s.onchange=aplicarFiltros;
 });

 /* FILTRO POR A√ëO */
 let s=document.getElementById("f_anio");
 [...new Set(datos.map(d=>d._anioFiscalizacion))]
  .sort((a,b)=>b-a)
  .forEach(v=>{
   if(v){
    let o=document.createElement("option");
    o.value=v;o.text=v;s.add(o);
   }
  });
 s.onchange=aplicarFiltros;
}

function valores(id){
 return [...document.getElementById(id).selectedOptions].map(o=>o.value);
}

/* ===== APLICAR FILTROS ===== */
function aplicarFiltros(){
 modoBusqueda=false;
 let f=datos.filter(d=>
  (!valores("f_estado").length||valores("f_estado").includes(d.estado)) &&
  (!valores("f_actividad").length||valores("f_actividad").includes(d.actividad)) &&
  (!valores("f_provincia").length||valores("f_provincia").includes(d.provincia)) &&
  (!valores("f_distrito").length||valores("f_distrito").includes(d.distrito)) &&
  (!valores("f_anio").length||valores("f_anio").includes(d._anioFiscalizacion))
 );

 dibujarMarcadores(f);
 construirHeatmap(f);
 actualizarContador(f);
 actualizarEstadisticas(f);

 f.length?mostrarMarcadores():ocultarMarcadores();
}

/* ===== ESTADISTICAS ===== */
function actualizarEstadisticas(lista){
 let panel=document.getElementById("panelStats");
 if(lista.length===datos.length){ panel.style.display="none"; return; }
 panel.style.display="block";

 let porAct={};
 lista.forEach(d=>porAct[d.actividad]=(porAct[d.actividad]||0)+1);

 let actividadesOrdenadas = Object.entries(porAct)
  .sort((a,b)=>b[1]-a[1]);

 let html="<b>üìå Por Actividad</b><br>";
 actividadesOrdenadas.forEach(([act,cant])=>{
  html+=`
   <div>
    <span class="color-box" style="background:${colorPorActividad(act)}"></span>
    ${act}: ${cant}
   </div>`;
 });
 document.getElementById("stats_actividad").innerHTML=html;

 let porDist={};
 lista.forEach(d=>porDist[d.distrito]=(porDist[d.distrito]||0)+1);
 let hd="<br><b>üèòÔ∏è Por Distrito</b><br>";
 for(let d in porDist) hd+=`${d}: ${porDist[d]}<br>`;
 document.getElementById("stats_geo").innerHTML=hd;

 document.getElementById("stats_total").innerHTML=
 `<br><b>Total general: ${lista.length}</b>`;
}

/* ===== CONTADOR ===== */
function actualizarContador(lista){
 document.getElementById("contador").innerHTML=
 "Total registros: <b>"+lista.length+"</b>";
}

/* ===== BUSCADOR ===== */
function buscar(){
 let t=document.getElementById("buscador").value.toLowerCase().trim();
 if(!t){ resetFiltros(); return; }

 modoBusqueda=true;

 let r=datos.filter(d=>
  String(d.codigo).toLowerCase().includes(t) ||
  String(d.razon).toLowerCase().includes(t)
 );

 if(!r.length){ alert("No se encontraron coincidencias"); return; }

 dibujarMarcadores(r);
 mostrarMarcadores();
 construirHeatmap(r);
 actualizarContador(r);
 actualizarEstadisticas(r);
 map.setCenter({lat:r[0].lat,lng:r[0].lng});
 map.setZoom(r.length==1?15:12);
}

/* ===== RESET ===== */
function resetFiltros(){
 modoBusqueda=false;
 document.querySelectorAll("select").forEach(s=>s.selectedIndex=-1);
 dibujarMarcadores(datos);
 construirHeatmap(datos);
 actualizarContador(datos);
 document.getElementById("panelStats").style.display="none";
 ocultarMarcadores();
}
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization&callback=initMap">
</script>

</body>
</html>























































