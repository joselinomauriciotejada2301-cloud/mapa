<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Interactivo OSINERGMIN</title>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 75%; float: right; }
    #panel {
      width: 25%;
      height: 100vh;
      float: left;
      overflow-y: auto;
      padding: 10px;
      background: #f5f5f5;
    }
    select, input, button {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
    }
    .legend {
      background: white;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
    }
    .legend-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>

<div id="panel">
  <h3>Filtros</h3>

  <input type="text" id="searchInput" placeholder="Buscar por código o razón social">

  <select id="actividadFilter" multiple></select>
  <select id="distritoFilter" multiple></select>
  <select id="provinciaFilter" multiple></select>

  <button onclick="toggleHeatmap()">Mapa de calor</button>

  <h4>Total de registros: <span id="totalCount">0</span></h4>

  <div class="legend" id="legend"></div>
</div>

<div id="map"></div>

<script>
let map;
let markers = [];
let heatmap;
let data = []; // ← aquí se carga tu JSON desde GitHub
let heatmapVisible = false;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: -12.0464, lng: -77.0428 },
    zoom: 6
  });

  fetch("data.json")
    .then(res => res.json())
    .then(json => {
      data = json;
      populateFilters();
      updateHeatmap();
      updateCounters(data);
    });
}

function populateFilters() {
  const actividad = new Set();
  const distrito = new Set();
  const provincia = new Set();

  data.forEach(d => {
    actividad.add(d.actividad);
    distrito.add(d.distrito);
    provincia.add(d.provincia);
  });

  fillSelect("actividadFilter", actividad);
  fillSelect("distritoFilter", distrito);
  fillSelect("provinciaFilter", provincia);
}

function fillSelect(id, values) {
  const select = document.getElementById(id);
  values.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    select.appendChild(opt);
  });
}

function getSelectedValues(id) {
  return [...document.getElementById(id).selectedOptions].map(o => o.value);
}

function applyFilters() {
  clearMarkers();

  const actividades = getSelectedValues("actividadFilter");
  const distritos = getSelectedValues("distritoFilter");
  const provincias = getSelectedValues("provinciaFilter");
  const search = document.getElementById("searchInput").value.toLowerCase();

  const filtersActive = actividades.length || distritos.length || provincias.length || search;

  let filtered = data.filter(d =>
    (!actividades.length || actividades.includes(d.actividad)) &&
    (!distritos.length || distritos.includes(d.distrito)) &&
    (!provincias.length || provincias.includes(d.provincia)) &&
    (!search || d.codigo.toLowerCase().includes(search) || d.razon_social.toLowerCase().includes(search))
  );

  document.getElementById("totalCount").innerText = filtered.length;

  if (filtersActive) {
    filtered.forEach(d => createMarker(d, search));
  }

  updateLegend(filtered);
}

function createMarker(d, search) {
  const highlight = search &&
    (d.codigo.toLowerCase().includes(search) || d.razon_social.toLowerCase().includes(search));

  const marker = new google.maps.Marker({
    position: { lat: d.lat, lng: d.lng },
    map,
    icon: highlight
      ? "http://maps.google.com/mapfiles/ms/icons/yellow-arrow.png"
      : d.icon
  });

  const info = `
    <b>${d.razon_social}</b><br>
    Código: ${d.codigo}<br>
    Actividad: ${d.actividad}<br>
    Distrito: ${d.distrito}<br>
    Provincia: ${d.provincia}<br>
    Capacidad: ${d.capacidad}<br>
    Última fiscalización: ${d.ultima_fiscalizacion}
  `;

  marker.addListener("click", () => {
    new google.maps.InfoWindow({ content: info }).open(map, marker);
  });

  markers.push(marker);
}

function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

function toggleHeatmap() {
  heatmapVisible = !heatmapVisible;
  if (heatmap) heatmap.setMap(heatmapVisible ? map : null);
}

function updateHeatmap() {
  const points = data.map(d =>
    new google.maps.LatLng(d.lat, d.lng)
  );
  heatmap = new google.maps.visualization.HeatmapLayer({
    data: points,
    radius: 25
  });
}

function updateLegend(filtered) {
  const legend = document.getElementById("legend");
  legend.innerHTML = "<h4>Estadísticas</h4>";

  const counts = {};
  filtered.forEach(d => {
    counts[d.actividad] = (counts[d.actividad] || 0) + 1;
  });

  Object.entries(counts).forEach(([act, count]) => {
    legend.innerHTML += `
      <div class="legend-item">
        <span>${act}</span>
        <b>${count}</b>
      </div>`;
  });
}

document.querySelectorAll("select, input").forEach(el =>
  el.addEventListener("change", applyFilters)
);

window.onload = initMap;
</script>

</body>
</html>






































