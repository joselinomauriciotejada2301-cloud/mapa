<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Mapa OSINERGMIN</title>

<style>
html, body {
 height:100%;
 margin:0;
 padding:0;
 font-family: Arial, sans-serif;
}

#map {
 height:100%;
 width:100%;
}

.panel {
 position:absolute;
 top:10px;
 left:10px;
 z-index:5;
 background:#fff;
 padding:10px;
 border-radius:6px;
 width:300px;
 box-shadow:0 2px 6px rgba(0,0,0,.3);
 font-size:13px;
}

.panel input,
.panel select,
.panel button {
 width:100%;
 margin-bottom:6px;
}

.stats {
 font-size:12px;
 max-height:200px;
 overflow:auto;
}
</style>
</head>

<body>

<div class="panel">

<b>ğŸ” Buscador</b>
<input type="text" id="buscador" placeholder="CÃ³digo o RazÃ³n Social">
<button onclick="buscar()">Buscar</button>

<hr>

<b>ğŸ›ï¸ Filtros</b>
<select id="f_estado" multiple></select>
<select id="f_actividad" multiple></select>
<select id="f_provincia" multiple></select>
<select id="f_distrito" multiple></select>

<button onclick="resetFiltros()">Limpiar filtros</button>

<hr>
<button onclick="toggleHeatmap()">ğŸ”¥ Activar / Desactivar Mapa de Calor</button>

<hr>
<div id="contador"></div>

<div class="stats">
 <div id="stats_actividad"></div>
 <div id="stats_geo"></div>
 <div id="stats_total"></div>
</div>

</div>

<div id="map"></div>

<script>
/* =====================================================
   VARIABLES ORIGINALES (NO SE TOCAN)
===================================================== */
let map;
let datos = [];
let marcadores = [];
let heatmap;
let heatmapActivo = false;

/* =====================================================
   FUNCIONES AUXILIARES (NUEVAS â€“ NO ROMPEN NADA)
===================================================== */

// Ocultar todos los marcadores
function ocultarMarcadores() {
 marcadores.forEach(m => m.setMap(null));
}

// Mostrar marcadores
function mostrarMarcadores() {
 marcadores.forEach(m => m.setMap(map));
}

// Saber si hay filtros activos
function hayFiltrosActivos() {
 return ["f_estado","f_actividad","f_provincia","f_distrito"]
   .some(id => document.getElementById(id).selectedOptions.length > 0);
}

/* =====================================================
   BUSCADOR (CORREGIDO Y FUNCIONAL)
===================================================== */
function buscar() {

 const texto = document.getElementById("buscador").value.trim().toLowerCase();
 if (texto === "") {
   resetFiltros();
   ocultarMarcadores();
   return;
 }

 const resultados = datos.filter(d =>
   String(d.codigo).toLowerCase().includes(texto) ||
   String(d.razon).toLowerCase().includes(texto)
 );

 if (resultados.length === 0) {
   alert("No se encontraron coincidencias");
   return;
 }

 dibujarMarcadores(resultados);
 mostrarMarcadores();

 // Resaltar coincidencias
 marcadores.forEach(m => {
   const d = resultados.find(r =>
     r.lat === m.getPosition().lat() &&
     r.lng === m.getPosition().lng()
   );
   if (d) {
     m.setIcon({
       path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
       scale: 6,
       fillColor: "red",
       fillOpacity: 1,
       strokeWeight: 1
     });
   }
 });

 construirHeatmap(resultados);
 actualizarContador(resultados);
 actualizarEstadisticas(resultados);

 map.setCenter({lat: resultados[0].lat, lng: resultados[0].lng});
 map.setZoom(14);
}

/* =====================================================
   INTERCEPCIÃ“N SEGURA DE FILTROS
===================================================== */
const _aplicarFiltros = aplicarFiltros;
aplicarFiltros = function() {
 _aplicarFiltros();

 if (hayFiltrosActivos()) {
   mostrarMarcadores();
 } else {
   ocultarMarcadores();
 }
};

/* =====================================================
   AL TERMINAR DE CARGAR â†’ OCULTAR MARCADORES
===================================================== */
window.addEventListener("load", () => {
 setTimeout(() => ocultarMarcadores(), 800);
});
</script>

<!-- GOOGLE MAPS -->
<script async defer
 src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization,geometry&callback=initMap">
</script>

</body>
</html>
































