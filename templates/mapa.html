<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa OSINERGMIN</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 100vh; width: 75%; float:left; }
  #panel {
    width:25%;
    height:100vh;
    overflow:auto;
    padding:10px;
    box-sizing:border-box;
    background:#f4f4f4;
  }
  select, input { width:100%; margin-bottom:8px; padding:6px; }
  button { width:100%; padding:8px; margin-top:5px; cursor:pointer; }
  .legend-item { margin:4px 0; font-size:14px; }
  .color-box {
    display:inline-block;
    width:14px;
    height:14px;
    margin-right:6px;
  }
</style>
</head>
<body>

<div id="panel">
  <h3>Filtros</h3>

  <input type="text" id="buscador" placeholder="Buscar raz√≥n social o c√≥digo">

  <select id="filtroProvincia"></select>
  <select id="filtroDistrito"></select>
  <select id="filtroActividad"></select>

  <button onclick="limpiarFiltros()">Limpiar filtros</button>

  <hr>
  <button onclick="toggleHeatmap()">üå°Ô∏è Mapa de Calor</button>

  <h3>Estad√≠sticas</h3>
  <div id="contador"></div>

  <h3>Leyenda</h3>
  <div id="leyenda"></div>
</div>

<div id="map"></div>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt7foEL44coYUN79fD5a-7EAb1xIG3Iks&libraries=visualization&callback=initMap" async defer></script>

<script>
let map;
let datos = [];
let marcadores = [];
let heatmap;
let heatmapActivo = false;

// üé® Colores por actividad (igual a tu versi√≥n actual)
const coloresActividad = {
  "Planta de abastecimiento": "#e74c3c",
  "Estaci√≥n de servicio": "#3498db",
  "Grifo": "#2ecc71",
  "Distribuidor": "#f1c40f",
  "Otro": "#9b59b6"
};

// üß≠ Flecha (marker) SVG
function crearIcono(color){
  return {
    path: "M12 2 L19 21 L12 17 L5 21 Z",
    fillColor: color,
    fillOpacity: 1,
    strokeWeight: 1,
    strokeColor: "#333",
    scale: 1.2
  };
}

function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:-9.19, lng:-75.015},
    zoom:6
  });

  fetch("/datos")
    .then(r => r.json())
    .then(json => {
      datos = json;
      cargarFiltros(datos);
      dibujarMarcadores(datos);
      actualizarLeyenda(datos);
      actualizarContador(datos);
      construirHeatmap(datos);
    });

  document.getElementById("buscador").addEventListener("input", aplicarFiltros);
  document.getElementById("filtroProvincia").addEventListener("change", aplicarFiltros);
  document.getElementById("filtroDistrito").addEventListener("change", aplicarFiltros);
  document.getElementById("filtroActividad").addEventListener("change", aplicarFiltros);
}

// ======================
// Filtros
// ======================
function cargarFiltros(lista){
  const provincias = [...new Set(lista.map(d=>d.provincia))].sort();
  const distritos = [...new Set(lista.map(d=>d.distrito))].sort();
  const actividades = [...new Set(lista.map(d=>d.actividad))].sort();

  llenarSelect("filtroProvincia", provincias, "Todas las provincias");
  llenarSelect("filtroDistrito", distritos, "Todos los distritos");
  llenarSelect("filtroActividad", actividades, "Todas las actividades");
}

function llenarSelect(id, opciones, textoDefault){
  const select = document.getElementById(id);
  select.innerHTML = `<option value="">${textoDefault}</option>`;
  opciones.forEach(op => {
    let option = document.createElement("option");
    option.value = op;
    option.textContent = op;
    select.appendChild(option);
  });
}

function aplicarFiltros(){
  const texto = document.getElementById("buscador").value.toLowerCase();
  const prov = document.getElementById("filtroProvincia").value;
  const dist = document.getElementById("filtroDistrito").value;
  const act = document.getElementById("filtroActividad").value;

  let filtrados = datos.filter(d => {
    return (
      (d.razon.toLowerCase().includes(texto) || d.codigo.toLowerCase().includes(texto)) &&
      (prov === "" || d.provincia === prov) &&
      (dist === "" || d.distrito === dist) &&
      (act === "" || d.actividad === act)
    );
  });

  dibujarMarcadores(filtrados);
  actualizarLeyenda(filtrados);
  actualizarContador(filtrados);

  if(heatmapActivo){
    construirHeatmap(filtrados);
    heatmap.setMap(map);
  }
}

function limpiarFiltros(){
  document.getElementById("buscador").value="";
  document.getElementById("filtroProvincia").value="";
  document.getElementById("filtroDistrito").value="";
  document.getElementById("filtroActividad").value="";
  aplicarFiltros();
}

// ======================
// Marcadores
// ======================
function dibujarMarcadores(lista){
  marcadores.forEach(m => m.setMap(null));
  marcadores = [];

  if(heatmapActivo) return;

  lista.forEach(d => {
    const color = coloresActividad[d.actividad] || coloresActividad["Otro"];

    const marker = new google.maps.Marker({
      position:{lat:d.lat, lng:d.lng},
      map: map,
      icon: crearIcono(color),
      title: d.razon
    });

    const info = `
      <b>${d.razon}</b><br>
      C√≥digo: ${d.codigo}<br>
      Actividad: ${d.actividad}<br>
      Provincia: ${d.provincia}<br>
      Distrito: ${d.distrito}<br>
      Capacidad: ${d.capacidad}
    `;

    const infowindow = new google.maps.InfoWindow({content:info});
    marker.addListener("click", ()=>infowindow.open(map,marker));

    marcadores.push(marker);
  });
}

// ======================
// Leyenda din√°mica
// ======================
function actualizarLeyenda(lista){
  const contenedor = document.getElementById("leyenda");
  contenedor.innerHTML = "";

  const conteo = {};
  lista.forEach(d=>{
    conteo[d.actividad] = (conteo[d.actividad]||0)+1;
  });

  Object.keys(conteo).forEach(act=>{
    const color = coloresActividad[act] || coloresActividad["Otro"];
    const div = document.createElement("div");
    div.className="legend-item";
    div.innerHTML = `<span class="color-box" style="background:${color}"></span>${act} (${conteo[act]})`;
    contenedor.appendChild(div);
  });
}

// ======================
// Contador total
// ======================
function actualizarContador(lista){
  document.getElementById("contador").innerHTML = "Registros: <b>"+lista.length+"</b>";
}

// ======================
// Heatmap
// ======================
function construirHeatmap(lista){
  let puntos = lista.map(d => ({
    location: new google.maps.LatLng(d.lat, d.lng),
    weight: Math.sqrt(d.capacidad || 1)
  }));

  if(heatmap){
    heatmap.setMap(null);
  }

  heatmap = new google.maps.visualization.HeatmapLayer({
    data: puntos,
    radius: 35,
    dissipating:true
  });
}

function toggleHeatmap(){
  heatmapActivo = !heatmapActivo;

  if(heatmapActivo){
    marcadores.forEach(m=>m.setMap(null));
    heatmap.setMap(map);
  }else{
    heatmap.setMap(null);
    dibujarMarcadores(datos);
  }
}
</script>
</body>
</html>























